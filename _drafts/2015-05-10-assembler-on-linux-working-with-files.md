---
layout:		post
comments:	true
title:		"Aссемблер для Linux: работа с файлами"
date:		2015-05-10
categories:
- linux
- asm
---

В UNIX многое представлено файлами, и поэтому работа с файлами производится наиболее удобным способом, при этом файлами представлены не только какие-то наборы данных, но и целые устройства.

Работа с файлами сводится к 3-м этапам:

1. Открытие файла т.е. получение его дексриптора,
2. Работа с файлом(чтение, запись) использя полученный дескриптор,
3. Закрытие файла т.е. инвалидирование дескриптора.

#### Открытие файла
Открытие файла производится с помощью системного вызова `open`(movl $5, %eax), который принимает режим, в котором необходимо открыть файл и набор разрешений, в качестве параметров, который вернет дескриптор в `%eax`.

`%ebx` - должен содержать адрес первого символа имени файла, который необходимо открыть
`%ecx` - должен содержать режим в котором мы хотим открыть файл(на чтение, на запись, и то, и другое и т.п.)
`%edx` - должен содержать набор разрешений, с которыми необходимо открыть файл

#### Работа с файлом
Работа с файлом производится используя системные вызовы `read`(3) и `write`(4).
Для чтения, необходимо чтобы регистр `%ebx` содержал дескриптор файла, `%ecx` - адрес буфера, в который будет произведено чтение и `%edx` размер буффера.
Для записи используется такой же синтаксис, как для чтения, только буффер должен быть предварительно заполнен необходимыми для записи данными.

#### Закрытие файла
Закрытие файла выполняется с помощью системного вызова `close`(6), которому требуется дескриптор файла в `%ebx`.

При запуске каждой программы, всегда открываются 3 файла: `STDIN`, `STDOUT`, `STDERR`.
Тут же мы узнаем, что в ассемблере есть `DEFINE/typedef`, и имя ему - `.equ`. Например, чтобы не запоминать номера вышесказанных системных вызовов, можно обьявить их однажды используя следующий код:

{% highlight asm %}
.equ SYS_OPEN, 5
.equ SYS_WRITE, 4
.equ SYS_READ, 3
.equ SYS_CLOSE, 6
.equ SYS_EXIT, 1
{% endhighlight %}
